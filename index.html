<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker</title>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>Planning Poker</h1>
    <div id="join-form">
        <!-- Initial choice buttons -->
        <div id="choice-buttons">
            <button id="show-create">Create Session</button>
            <button id="show-join">Join Session</button>
        </div>

        <!-- Create form -->
        <div id="create-form" style="display:none; flex-direction:column; align-items:center; gap:10px;">
            <input id="name-create" placeholder="Your Name" required>
            <button id="create-session">Start</button>
            <button class="back-btn">⬅ Back</button>
        </div>

        <!-- Join form -->
        <div id="join-fields" style="display:none; flex-direction:column; align-items:center; gap:10px;">
            <input id="name-join" placeholder="Your Name" required>
            <input id="session-input" placeholder="Session ID" required>
            <button id="join-session">Join</button>
            <button class="back-btn">⬅ Back</button>
        </div>
    </div>
    <div id="session-info"></div>
    <div id="controls">
        <button id="reveal-cards">Reveal</button>
        <button id="reset-round">Reset</button>
    </div>
    <div id="table"></div>
    <div id="card-deck" class="card-container"></div>
    <script>
        const firebaseConfig = {
            apiKey: "{{FIREBASE_API_KEY}}",
            authDomain: "{{FIREBASE_AUTH_DOMAIN}}",
            databaseURL: "{{FIREBASE_DATABASE_URL}}",
            projectId: "{{FIREBASE_PROJECT_ID}}",
            storageBucket: "{{FIREBASE_STORAGE_BUCKET}}",
            messagingSenderId: "{{FIREBASE_MESSAGING_SENDER_ID}}",
            appId: "{{FIREBASE_APP_ID}}"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Show/hide create/join forms
        document.getElementById("show-create").addEventListener("click", () => {
            document.getElementById("choice-buttons").style.display = "none";
            document.getElementById("create-form").style.display = "flex";
        });

        document.getElementById("show-join").addEventListener("click", () => {
            document.getElementById("choice-buttons").style.display = "none";
            document.getElementById("join-fields").style.display = "flex";
        });

        // Back button logic
        document.querySelectorAll(".back-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.getElementById("create-form").style.display = "none";
                document.getElementById("join-fields").style.display = "none";
                document.getElementById("choice-buttons").style.display = "flex";
            });
        });

        document.getElementById("create-session").addEventListener("click", createSession);
        document.getElementById("join-session").addEventListener("click", joinSession);
        document.getElementById("reveal-cards").addEventListener("click", revealCards);
        document.getElementById("reset-round").addEventListener("click", resetRound);

        const values = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '12', '14', '16', '20', '22', '24', '26', '28', '30', '?'];
        let session_id = null;
        let user_id = null;
        let user_name = null;
        let is_revealed = false;
        let users = {};
        let is_host = false;

        const table = document.getElementById('table');
        const deck = document.getElementById('card-deck');
        const joinForm = document.getElementById('join-form');
        const session_info = document.getElementById('session-info');
        const sessionInfo = document.getElementById('session-info');
        const controls = document.getElementById('controls');
        const average_display = document.createElement('div');
        average_display.id = 'average-display';
        session_info.after(average_display);

        // Generate random session ID
        function generateId(length = 6) {
            return Math.random().toString(36).substring(2, 2 + length).toUpperCase();
        }

        // Create session
        function createSession() {
            // For create
            user_name = document.getElementById('name-create')?.value.trim();

            if (!user_name) return alert('Enter your name');
            session_id = generateId();
            joinUser();
        }

        // Join session
        function joinSession() {
            // For join
            user_name = document.getElementById('name-join')?.value.trim();

            session_id = document.getElementById('session-input').value.trim();
            if (!user_name || !session_id) return alert('Enter name and session ID');
            joinUser();
        }

        // Join logic
        function joinUser() {
            const session_ref = db.ref('sessions/' + session_id);
            session_ref.once('value').then(snap => {

                // Initialize if new session
                if (!snap.exists()) {
                    session_ref.set({
                        revealed: false,
                        users: {},
                        host: null,
                        createdAt: Date.now(),
                        average: null
                    });
                }

                let data = snap.val() || { users: {}, host: null };

                const userCount = Object.keys(data.users || {}).length;
                if (userCount >= 10) {
                    return alert('Session full (max 10)');
                }

                user_id = session_ref.child('users').push().key;
                session_ref.child('users/' + user_id).set({ name: user_name, choice: null, is_host: is_host });
                session_ref.child('users/' + user_id).onDisconnect().remove();

                // If there's no host, assign one
                if (!data.host) {
                    session_ref.update({ host: user_id });
                    console.log(`Made host: ${user_id}`);
                    is_host = true;
                }

                // Reassign the host if the one before leaves.
                session_ref.child('users/' + user_id).onDisconnect().update({
                    '/host': userCount === 0 ? null : Object.keys(data.users || {})[0] || null
                });

                joinForm.style.display = 'none';
                sessionInfo.textContent = `Session ID: ${session_id} (share this!)`;
                sessionInfo.style.display = 'block';
                controls.style.display = 'flex';
                deck.style.display = 'flex';
                setupDeck();
                listenToSession();
            });
        }

        // Listen for changes
        function listenToSession() {
            db.ref('sessions/' + session_id).on('value', snap => {
                const data = snap.val();

                if (!data) {
                    return;
                }

                is_revealed = data.revealed;
                users = data.users || {};
                is_host = data.host === user_id;

                if (data.createdAt) {
                    const elapsed_mins = (Date.now() - data.createdAt) / (1000 * 60);

                    // After 120 minutes
                    if (elapsed_mins >= 120) {
                        alert("Session limit reached!");
                        db.ref('sessions/' + session_id).remove();
                        location.reload();
                    }
                }

                average_display.textContent = is_revealed && data.average ? `Average: ${data.average}` : is_revealed ? 'Average: N/A' : '';

                renderTable();
            });
        }

        // Render users around table
        function renderTable() {
            table.innerHTML = '';
            const user_list = Object.entries(users);
            const n = user_list.length;
            user_list.forEach(([uid, user], i) => {
                const angle = (360 / n) * i;
                const radius = Math.min(60, 20 + n * 6); // Adjust radius based on n
                const x = 50 + radius * Math.cos(angle * Math.PI / 180);
                const y = 30 + radius * Math.sin(angle * Math.PI / 180);

                const user_div = document.createElement('div');
                user_div.classList.add('user');
                if (uid === user_id) user_div.classList.add('own');
                user_div.style.left = `${x}%`;
                user_div.style.top = `${y}%`;

                const name_paragraph = document.createElement('p');
                name_paragraph.classList.add('user-name');
                name_paragraph.textContent = user.name;
                user_div.appendChild(name_paragraph);

                // Add Transfer Host button for non-host users, visible only to host
                if (is_host && uid !== user_id) {
                    const transfer_button = document.createElement('button');
                    transfer_button.classList.add('transfer-host-btn');
                    transfer_button.textContent = 'Make Host';
                    transfer_button.onclick = () => transferHost(uid);
                    user_div.appendChild(transfer_button);
                }

                if (!user.choice) {
                    const waiting = document.createElement('div');
                    waiting.classList.add('card-placeholder', 'waiting');
                    waiting.textContent = 'Waiting';
                    user_div.appendChild(waiting);
                } else {
                    const flip_container = document.createElement('div');
                    flip_container.classList.add('flip-container');
                    if (is_revealed) {
                        flip_container.classList.add('flipped');
                    }
                    const flipper = document.createElement('div');
                    flipper.classList.add('flipper');

                    const front = document.createElement('div');
                    front.classList.add('front');
                    front.textContent = 'Card';

                    const back = document.createElement('div');
                    back.classList.add('back');
                    back.textContent = user.choice;
                    back.style.background = getCardBackground(user.choice);

                    flipper.appendChild(front);
                    flipper.appendChild(back);
                    flip_container.appendChild(flipper);
                    user_div.appendChild(flip_container);
                }

                table.appendChild(user_div);
            });
        }

        // Get card background based on value
        function getCardBackground(val) {
            if (val === '?') return 'linear-gradient(135deg, #667eea, #764ba2)';
            if (val === '☕') return 'linear-gradient(135deg, #ff9966, #ff5e62)';
            return 'linear-gradient(135deg, #4facfe, #00f2fe)';
        }

        function setupDeck() {
            values.forEach(val => {
                const card = document.createElement('div');
                card.classList.add('card');
                if (val === '?') card.classList.add('question');
                if (val === '☕') card.classList.add('coffee');
                card.textContent = val;
                card.onclick = () => selectCard(val);
                deck.appendChild(card);
            });
        }

        function selectCard(val) {
            // Remove .selected from all cards in deck
            const cards = deck.querySelectorAll('.card');
            cards.forEach(card => card.classList.remove('selected'));

            // Add .selected to the clicked card
            const selected_card = Array.from(cards).find(card => card.textContent === val);
            if (selected_card) {
                selected_card.classList.add('selected');
            }

            // Update Firebase with the choice
            db.ref('sessions/' + session_id + '/users/' + user_id).update({ choice: val });
        }

        function transferHost(new_host_id) {
            if (!is_host) {
                return;
            }
            db.ref('sessions/' + session_id).update({ host: new_host_id });
        }

        function calculate_average(choices) {
            const numeric_values = choices
                .filter(choice => !isNaN(parseFloat(choice)) && choice !== '?')
                .map(choice => parseFloat(choice));
            return numeric_values.length > 0
                ? (numeric_values.reduce((sum, val) => sum + val, 0) / numeric_values.length).toFixed(1)
                : null;
        }

        function revealCards() {
            if (!is_host) {
                return;
            }

            const choices = Object.values(users).map(user => user.choice).filter(choice => choice);
            const average = calculate_average(choices);
            db.ref('sessions/' + session_id).update({ revealed: true, average: average });
        }

        function resetRound() {
            if (!is_host) {
                return;
            }
            const updates = { revealed: false };
            Object.keys(users).forEach(uid => {
                updates[`users/${uid}/choice`] = null;
            });
            db.ref('sessions/' + session_id).update(updates);
        }

    </script>
</body>

</html>