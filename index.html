<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker</title>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>Planning Poker</h1>
    <div id="join-form">
        <!-- Initial choice buttons -->
        <div id="choice-buttons">
            <button id="show-create" onclick="showCreate()">Create Session</button>
            <button id="show-join" onclick="showJoin()">Join Session</button>
        </div>

        <!-- Create form -->
        <div id="create-form" style="display:none; flex-direction:column; align-items:center; gap:10px;">
            <input id="name-create" placeholder="Your Name" required>
            <button id="create-session" onclick="createSession()">Start</button>
            <button class="back-btn" onclick="goBack()">⬅ Back</button>
        </div>

        <!-- Join form -->
        <div id="join-fields" style="display:none; flex-direction:column; align-items:center; gap:10px;">
            <input id="name-join" placeholder="Your Name" required>
            <input id="session-input" placeholder="Session ID" required>
            <button id="join-session" onclick="joinSession()">Join</button>
            <button class="back-btn" onclick="goBack()">⬅ Back</button>
        </div>
    </div>
    <div id="session-info"></div>
    <div id="controls">
        <button id="reveal-cards" onclick="revealCards()">Reveal</button>
        <button id="reset-round" onclick="resetRound()">Reset</button>
    </div>
    <div id="user-list"></div>
    <div id="table"></div>
    <div id="card-deck" class="card-container"></div>
    <script>
        const firebaseConfig = {
            apiKey: "{{FIREBASE_API_KEY}}",
            authDomain: "{{FIREBASE_AUTH_DOMAIN}}",
            databaseURL: "{{FIREBASE_DATABASE_URL}}",
            projectId: "{{FIREBASE_PROJECT_ID}}",
            storageBucket: "{{FIREBASE_STORAGE_BUCKET}}",
            messagingSenderId: "{{FIREBASE_MESSAGING_SENDER_ID}}",
            appId: "{{FIREBASE_APP_ID}}"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        /// ======================================
        ///           Document elements
        /// ======================================
        const table = document.getElementById('table');
        const deck = document.getElementById('card-deck');
        const join_form = document.getElementById('join-form');
        const session_info = document.getElementById('session-info');
        const controls = document.getElementById('controls');
        const average_display = document.createElement('div');
        const user_list_container = document.getElementById('user-list');
        user_list_container.style.display = "none";

        average_display.id = 'average-display';
        session_info.after(average_display);

        const choice_buttons = document.getElementById("choice-buttons");
        const create_lobby_button = document.getElementById("create-form");
        const join_lobby_button = document.getElementById("join-fields");

        function showCreate() {
            choice_buttons.style.display = "none";
            create_lobby_button.style.display = "flex";
        }

        function showJoin() {
            choice_buttons.style.display = "none";
            join_lobby_button.style.display = "flex";
        }

        function goBack() {
            create_lobby_button.style.display = "none";
            join_lobby_button.style.display = "none";
            choice_buttons.style.display = "flex";
        }

        /// ======================================
        ///               Variables
        /// ======================================
        const values = [
            '1', '2', '3', '4', '5', '6', '7', '8', '9',
            '10', '12', '14', '16',
            '20', '22', '24', '26', '28',
            '30', '32', '34', '36', '38',
            '40'
        ];
        let session_id = null;
        let user_id = null;
        let user_name = null;
        let is_revealed = false;
        let users = {};
        let is_host = false;

        function generateId(length = 6) {
            return Math.random().toString(36).substring(2, 2 + length).toUpperCase();
        }

        function createSession() {
            user_name = document.getElementById('name-create')?.value.trim();
            if (!user_name) {
                return alert('Enter your name');
            }

            if (user_name.length > 9) {
                return alert("Username cant be bigger than 9 characters!");
            }

            session_id = generateId();

            joinUser();
        }

        function joinSession() {
            user_name = document.getElementById('name-join')?.value.trim();
            session_id = document.getElementById('session-input').value.trim();
            if (!user_name || !session_id) {
                return alert('Enter name and session ID');
            }

            if (user_name.length > 9) {
                return alert("Username cant be bigger than 9 characters!");
            }

            joinUser();
        }

        // Join logic
        function joinUser() {
            const session_ref = db.ref('sessions/' + session_id);
            session_ref.once('value').then(snap => {

                // Initialize if new session
                if (!snap.exists()) {
                    session_ref.set({
                        revealed: false,
                        users: {},
                        host: null,
                        createdAt: Date.now(),
                        average: null
                    });
                }

                let data = snap.val() || { users: {}, host: null };

                const userCount = Object.keys(data.users || {}).length;
                if (userCount >= 10) {
                    return alert('Session full (max 10)');
                }

                const existing_names = Object.values(data.users || {}).map(user => user.name);
                if (existing_names.includes(user_name)) {
                    return alert('Username already exists in this session. Please choose a different name.');
                }

                user_id = session_ref.child('users').push().key;
                session_ref.child('users/' + user_id).set({ name: user_name, choice: null, is_host: is_host });
                session_ref.child('users/' + user_id).onDisconnect().remove(_ => {
                    session_ref.update({ host: userCount === 0 ? null : Object.keys(data.users || {})[0] || null });
                });

                // If there's no host, assign one
                if (!data.host) {
                    session_ref.update({ host: user_id });
                    is_host = true;
                }

                join_form.style.display = 'none';
                session_info.textContent = `Session ID: ${session_id} (share this!)`;
                session_info.style.display = 'block';
                controls.style.display = 'flex';
                deck.style.display = 'flex';
                user_list_container.style.display = "block";
                setupDeck();
                listenToSession();
            });
        }

        // Listen for changes
        function listenToSession() {
            db.ref('sessions/' + session_id).on('value', snap => {
                const data = snap.val();

                if (!data) {
                    return;
                }

                is_revealed = data.revealed;
                users = data.users || {};
                is_host = data.host === user_id;

                average_display.textContent = is_revealed && data.average ? `Average: ${data.average}` : is_revealed ? 'Average: N/A' : '';

                renderTable();
                render_user_list(data.host);
            });
        }

        // Render users around table
        function renderTable() {
            table.innerHTML = '';
            const user_list = Object.entries(users);
            const n = user_list.length;

            const table_width = 65; // Percentage width of the table (from styles.css)
            const card_width = 120; // Width of each card in pixels
            const total_width = Math.min(650, card_width + (n - 1) * (card_width + 20)); // Max 650px, with 20px margin between cards
            const start_x = (table_width - (total_width / 6.5)) / 2; // Center the row, converting % to px ratio

            user_list.forEach(([uid, user], i) => {
                const x = start_x + (i * (card_width + 20)) / 6.5; // Linear positioning across the table width
                const y = 50; // Fixed vertical center for all cards

                const user_div = document.createElement('div');
                user_div.classList.add('user');
                if (uid === user_id) {
                    user_div.classList.add('own')
                };
                user_div.style.left = `${x}%`;
                user_div.style.top = `${y}%`;

                const name_span = document.createElement('span');
                name_span.classList.add('user-name');
                name_span.textContent = user.name + (uid === db.ref('sessions/' + session_id + '/host').key ? ' (Host)' : '');

                if (!user.choice) {
                    const waiting = document.createElement('div');
                    waiting.classList.add('card-placeholder', 'waiting');
                    waiting.textContent = 'Waiting';
                    waiting.appendChild(name_span);
                    user_div.appendChild(waiting);
                } else {
                    const flip_container = document.createElement('div');
                    flip_container.classList.add('flip-container');
                    if (is_revealed) {
                        flip_container.classList.add('flipped');
                    }
                    const flipper = document.createElement('div');
                    flipper.classList.add('flipper');

                    const front = document.createElement('div');
                    front.classList.add('front');
                    front.textContent = 'Card';

                    const back = document.createElement('div');
                    back.classList.add('back');
                    back.textContent = user.choice;
                    back.style.background = getCardBackground(user.choice);
                    back.appendChild(name_span);

                    flipper.appendChild(front);
                    flipper.appendChild(back);
                    flip_container.appendChild(flipper);
                    user_div.appendChild(flip_container);
                }

                table.appendChild(user_div);
            });
        }

        function render_user_list(host_id) {
            user_list_container.innerHTML = '';
            const user_list = Object.entries(users);
            user_list.forEach(([uid, user]) => {
                const list_item = document.createElement('div');
                list_item.classList.add('user-list-item');
                if (uid === user_id) {
                    list_item.classList.add('own');
                }
                const name_span = document.createElement('span');
                name_span.textContent = user.name + (uid == user_id ? ' (You)' : '') + (uid === host_id ? ' (Host)' : '');
                list_item.appendChild(name_span);

                if (is_host && uid !== user_id) {
                    const transfer_btn = document.createElement('button');
                    transfer_btn.textContent = 'Make Host';
                    transfer_btn.classList.add('transfer-host-btn');
                    transfer_btn.onclick = () => transferHost(uid);
                    list_item.appendChild(transfer_btn);
                }

                user_list_container.appendChild(list_item);
            });
        }

        // Get card background based on value
        function getCardBackground(val) {
            if (val === '?') return 'linear-gradient(135deg, #667eea, #764ba2)';
            return 'linear-gradient(135deg, #4facfe, #00f2fe)';
        }

        function setupDeck() {
            values.forEach(val => {
                const card = document.createElement('div');
                card.classList.add('card');
                if (val === '?') card.classList.add('question');
                if (val === '☕') card.classList.add('coffee');
                card.textContent = val;
                card.onclick = () => selectCard(val);
                deck.appendChild(card);
            });
        }

        function selectCard(val) {
            // Remove .selected from all cards in deck
            const cards = deck.querySelectorAll('.card');
            cards.forEach(card => card.classList.remove('selected'));

            // Add .selected to the clicked card
            const selected_card = Array.from(cards).find(card => card.textContent === val);
            if (selected_card) {
                selected_card.classList.add('selected');
            }

            // Update Firebase with the choice
            db.ref('sessions/' + session_id + '/users/' + user_id).update({ choice: val });
        }

        function transferHost(new_host_id) {
            if (!is_host) {
                return;
            }
            db.ref('sessions/' + session_id).update({ host: new_host_id });
        }

        function calculate_average(choices) {
            const numeric_values = choices
                .filter(choice => !isNaN(parseFloat(choice)) && choice !== '?')
                .map(choice => parseFloat(choice));
            return numeric_values.length > 0
                ? (numeric_values.reduce((sum, val) => sum + val, 0) / numeric_values.length).toFixed(1)
                : null;
        }

        function revealCards() {
            if (!is_host) {
                return;
            }

            const choices = Object.values(users).map(user => user.choice).filter(choice => choice);
            const average = calculate_average(choices);
            db.ref('sessions/' + session_id).update({ revealed: true, average: average });
        }

        function resetRound() {
            if (!is_host) {
                return;
            }

            const updates = { revealed: false };
            Object.keys(users).forEach(uid => {
                updates[`users/${uid}/choice`] = null;
            });
            db.ref('sessions/' + session_id).update(updates);
        }

    </script>
</body>

</html>