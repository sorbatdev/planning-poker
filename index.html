<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker</title>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #333;
            overflow: hidden;
        }
        h1 {
            font-size: 2em;
            margin: 20px 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        #join-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        #join-form input {
            padding: 8px;
            width: 200px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #join-form button {
            padding: 8px 16px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #session-info {
            font-size: 1.2em;
            margin-bottom: 10px;
            display: none;
        }
        #table {
            position: relative;
            width: 80vw;
            height: 50vh;
            max-width: 800px;
            margin: auto;
        }
        .user {
            position: absolute;
            text-align: center;
            width: 120px;
            transform: translate(-50%, -50%);
        }
        .user-name {
            font-size: 1em;
            margin-bottom: 5px;
        }
        .card-placeholder {
            width: 100px;
            height: 150px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .waiting {
            background: #ccc;
            color: #666;
        }
        .flip-container {
            perspective: 1000px;
        }
        .flipper {
            transition: 0.6s;
            transform-style: preserve-3d;
            position: relative;
            width: 100px;
            height: 150px;
        }
        .front, .back {
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .front {
            z-index: 2;
            transform: rotateY(0deg);
        }
        .back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            color: #333;
            font-size: 1em;
        }
        .flip-container.flipped .flipper {
            transform: rotateY(180deg);
        }
        .own .user-name {
            font-weight: bold;
        }
        #controls {
            display: none;
            gap: 10px;
            margin: 10px 0;
        }
        #controls button {
            padding: 8px 16px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #card-deck {
            position: fixed;
            bottom: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            width: 100%;
            overflow-x: auto;
            display: none;
        }
        .card {
            width: 80px;
            height: 120px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card.selected {
            transform: scale(1.05);
            border: 2px solid #fff;
        }
        .question {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .coffee {
            background: linear-gradient(135deg, #ff9966, #ff5e62);
            font-size: 1.5em;
        }
        @media (max-width: 600px) {
            .card-placeholder, .flipper, .front, .back {
                width: 60px;
                height: 90px;
                font-size: 1.5em;
            }
            .user {
                width: 80px;
            }
            .card {
                width: 50px;
                height: 75px;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <h1>Planning Poker</h1>
    <div id="join-form">
        <input id="name-input" placeholder="Your Name" required>
        <input id="session-input" placeholder="Session ID (for joining)">
        <button onclick="createSession()">Create Session</button>
        <button onclick="joinSession()">Join Session</button>
    </div>
    <div id="session-info"></div>
    <div id="controls">
        <button onclick="revealCards()">Reveal</button>
        <button onclick="resetRound()">Reset</button>
    </div>
    <div id="table"></div>
    <div id="card-deck" class="card-container"></div>

    <script>
        const firebaseConfig = {
            apiKey: "{{FIREBASE_API_KEY}}",
            authDomain: "{{FIREBASE_AUTH_DOMAIN}}",
            databaseURL: "{{FIREBASE_DATABASE_URL}}",
            projectId: "{{FIREBASE_PROJECT_ID}}",
            storageBucket: "{{FIREBASE_STORAGE_BUCKET}}",
            messagingSenderId: "{{FIREBASE_MESSAGING_SENDER_ID}}",
            appId: "{{FIREBASE_APP_ID}}"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const values = ['0', '1', '2', '3', '5', '8', '13', '20', '40', '60', '100', '?', '☕'];
        let sessionId = null;
        let userId = null;
        let userName = null;
        let revealed = false;
        let users = {};

        const table = document.getElementById('table');
        const deck = document.getElementById('card-deck');
        const joinForm = document.getElementById('join-form');
        const sessionInfo = document.getElementById('session-info');
        const controls = document.getElementById('controls');

        // Generate random session ID
        function generateId(length = 6) {
            return Math.random().toString(36).substring(2, 2 + length).toUpperCase();
        }

        // Create session
        function createSession() {
            userName = document.getElementById('name-input').value.trim();
            if (!userName) return alert('Enter your name');
            sessionId = generateId();
            joinUser();
        }

        // Join session
        function joinSession() {
            userName = document.getElementById('name-input').value.trim();
            sessionId = document.getElementById('session-input').value.trim();
            if (!userName || !sessionId) return alert('Enter name and session ID');
            joinUser();
        }

        // Join logic
        function joinUser() {
            const sessionRef = db.ref('sessions/' + sessionId);
            sessionRef.once('value').then(snap => {
                let data = snap.val() || { users: {} };
                const userCount = Object.keys(data.users || {}).length;
                if (userCount >= 10) return alert('Session full (max 10)');
                userId = sessionRef.child('users').push().key;
                sessionRef.child('users/' + userId).set({ name: userName, choice: null });
                sessionRef.child('users/' + userId).onDisconnect().remove();

                // Initialize if new session
                if (!snap.exists()) {
                    sessionRef.set({ revealed: false, users: {} });
                }

                joinForm.style.display = 'none';
                sessionInfo.textContent = `Session ID: ${sessionId} (share this!)`;
                sessionInfo.style.display = 'block';
                controls.style.display = 'flex';
                deck.style.display = 'flex';
                setupDeck();
                listenToSession();
            });
        }

        // Listen for changes
        function listenToSession() {
            db.ref('sessions/' + sessionId).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                revealed = data.revealed;
                users = data.users || {};
                renderTable();
            });
        }

        // Render users around table
        function renderTable() {
            table.innerHTML = '';
            const userList = Object.entries(users);
            const n = userList.length;
            userList.forEach(([uid, user], i) => {
                const angle = (360 / n) * i;
                const radius = Math.min(40, 20 + n * 2); // Adjust radius based on n
                const x = 50 + radius * Math.cos(angle * Math.PI / 180);
                const y = 50 + radius * Math.sin(angle * Math.PI / 180);
                
                const userDiv = document.createElement('div');
                userDiv.classList.add('user');
                if (uid === userId) userDiv.classList.add('own');
                userDiv.style.left = `${x}%`;
                userDiv.style.top = `${y}%`;
                
                const nameP = document.createElement('p');
                nameP.classList.add('user-name');
                nameP.textContent = user.name;
                userDiv.appendChild(nameP);
                
                if (!user.choice) {
                    const waiting = document.createElement('div');
                    waiting.classList.add('card-placeholder', 'waiting');
                    waiting.textContent = 'Waiting';
                    userDiv.appendChild(waiting);
                } else {
                    const flipContainer = document.createElement('div');
                    flipContainer.classList.add('flip-container');
                    if (revealed) flipContainer.classList.add('flipped');
                    
                    const flipper = document.createElement('div');
                    flipper.classList.add('flipper');
                    
                    const back = document.createElement('div');
                    back.classList.add('back');
                    back.textContent = 'Card';
                    
                    const front = document.createElement('div');
                    front.classList.add('front');
                    front.textContent = user.choice;
                    front.style.background = getCardBackground(user.choice);
                    
                    flipper.appendChild(back);
                    flipper.appendChild(front);
                    flipContainer.appendChild(flipper);
                    userDiv.appendChild(flipContainer);
                }
                
                table.appendChild(userDiv);
            });
        }

        // Get card background based on value
        function getCardBackground(val) {
            if (val === '?') return 'linear-gradient(135deg, #667eea, #764ba2)';
            if (val === '☕') return 'linear-gradient(135deg, #ff9966, #ff5e62)';
            return 'linear-gradient(135deg, #4facfe, #00f2fe)';
        }

        // Setup selection deck
        function setupDeck() {
            values.forEach(val => {
                const card = document.createElement('div');
                card.classList.add('card');
                if (val === '?') card.classList.add('question');
                if (val === '☕') card.classList.add('coffee');
                card.textContent = val;
                card.onclick = () => selectCard(val);
                deck.appendChild(card);
            });
        }

        // Select card
        function selectCard(val) {
            db.ref('sessions/' + sessionId + '/users/' + userId).update({ choice: val });
        }

        // Reveal
        function revealCards() {
            db.ref('sessions/' + sessionId).update({ revealed: true });
        }

        // Reset
        function resetRound() {
            const updates = { revealed: false };
            Object.keys(users).forEach(uid => {
                updates[`users/${uid}/choice`] = null;
            });
            db.ref('sessions/' + sessionId).update(updates);
        }
    </script>
</body>
</html>
